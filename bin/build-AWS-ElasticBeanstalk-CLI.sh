#!/bin/bash
. "`dirname -- "$0"`"/functions.sh || exit

SDK_URL="$(curl -sL "http://aws.amazon.com/code/6752709412171743" | egrep -o 'https://s3.amazonaws.com/elasticbeanstalk/cli/AWS-ElasticBeanstalk-CLI-[0-9\.]*.zip' | head -n1)"
dest="$DOTFILES_DEST/AWS-ElasticBeanstalk-CLI"

cd_tmpdir && (
  ZIP_NAME="${SDK_URL##*/}"
  DIR_NAME="${ZIP_NAME%.zip}"
  if [[ -f "$dest/$DIR_NAME" ]]; then
    echo "Latest version is allready installed."
  else
    set -e
    curl -LO "$SDK_URL"
    unzip "$ZIP_NAME"
    [[ -d "$DIR_NAME" ]]
    rm -rf "$dest"
    mv "$DIR_NAME" "$dest"
    touch "$dest/$DIR_NAME"
  fi
)

# create startup script
( echo "# generated by $DOTFILES_DIR/bin/$(basename -- "$0")"
cat <<'EOF'
if [[ ${OSTYPE:0:5} == linux ]]; then
  case "$( python -V 2>&1 )" in
    *" 2.7"*) export PATH="$DOTFILES_DIR/.env/dest/AWS-ElasticBeanstalk-CLI/eb/linux/python2.7:$PATH" ;;
    *" 3."*) export PATH="$DOTFILES_DIR/.env/dest/AWS-ElasticBeanstalk-CLI/eb/linux/python3:$PATH" ;;
  esac
fi
EOF
) | make_profile_script 20-"${dest##*/}".sh
