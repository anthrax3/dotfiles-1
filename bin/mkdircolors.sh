#!/bin/sh
base="`dirname "$0"`/.."; base="`pwd`"
prog="$base/bin/`basename "$0"`"
src="$base/env/src/dircolors-solarized"
dest="$base/env/dest/dircolors-solarized"
mkdir -p "$src" "$dest" || exit 1

if [ ! -d "$src/.git" ]; then
  git clone https://github.com/seebi/dircolors-solarized.git "$src" || exit 1
fi
cd "$src" || exit 1
git pull

# 環境に合わせてエラー行を削除する
srcfile="$src/dircolors.256dark"
destfile="$dest/dircolors.256dark"
cp "$srcfile" "$destfile"
dircolors dircolors.256dark 2>&1 | grep "unrecognized keyword" | perl -pe's/.* //' |
while read key; do
  perl -i -pe"s/^$key /#\$&/" "$destfile"
done

# 完成品を自動読込させる
mkdir -p ~/.profile.d || exit 1
( echo "# generated by $prog"
  dircolors "$destfile"
) > "$base/skel/.profile.d/30-dotfiles-dircolors.sh"
