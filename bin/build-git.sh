#!/bin/sh
. "`dirname -- "$0"`"/functions.sh || exit

src="$DOTFILES_DIR/env/src/git"
dest="$DOTFILES_DIR/env/dest/git"

# 必要パッケージのチェック
has_perl_modules ExtUtils::MakeMaker || exit 1
has_rpm_packages expat-devel gettext autoconf zlib-devel || exit 1
has_rpm_packages libcurl-devel || has_rpm_packages curl-devel || exit 1

# get sources
if [ ! -d "$src/.git" ]; then
  git clone git://github.com/gitster/git.git "$src" || exit 1
fi
cd "$src" || exit 1
git pull --rebase

# install
make configure && ./configure --prefix="$dest" && make && make install || exit 1

# create startup script
( echo "# generated by $DOTFILES_DIR/bin/$(basename -- "$0")"
  echo "export PATH=\"$dest/bin:\$PATH\""
  echo "if [ -r \"$src/contrib/completion/git-completion.bash\" ]; then "
  echo "  . \"$src/contrib/completion/git-completion.bash\""
  echo "fi"
) | make_profile_script 10-git.sh
